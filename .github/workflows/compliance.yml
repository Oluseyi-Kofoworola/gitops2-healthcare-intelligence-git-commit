name: Compliance Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Daily compliance check

jobs:
  ##############################################################################
  # OPA Policy Validation
  ##############################################################################
  policy-validation:
    name: OPA Policy Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
          
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest
          
      - name: Test OPA policies
        run: |
          echo "üè• Testing OPA policies..."
          opa test policies/ --verbose
          
      - name: Validate policy coverage
        run: |
          echo "‚úì Validating HIPAA/FDA/SOX policy coverage..."
          
          # Check HIPAA policies
          if grep -r -l "HIPAA\|PHI\|patient" policies/ --include="*.rego" > /dev/null 2>&1; then
            echo "‚úÖ HIPAA policy coverage found"
          else
            echo "‚ö†Ô∏è  HIPAA policy coverage recommended"
          fi
          
          # Check FDA policies  
          if grep -r -l "FDA\|medical\|device\|clinical" policies/ --include="*.rego" > /dev/null 2>&1; then
            echo "‚úÖ FDA policy coverage found"
          else
            echo "‚ö†Ô∏è  FDA policy coverage recommended"
          fi
          
          # Check SOX policies
          if grep -r -l "SOX\|financial\|audit\|control" policies/ --include="*.rego" > /dev/null 2>&1; then
            echo "‚úÖ SOX policy coverage found"
          else
            echo "‚ö†Ô∏è  SOX policy coverage recommended"
          fi
          
          echo "‚úÖ All compliance policies validated"

  ##############################################################################
  # PHI/PII Detection
  ##############################################################################
  phi-detection:
    name: PHI/PII Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install pyyaml
          
      - name: Scan for PHI/PII patterns
        run: |
          echo "üè• Scanning for PHI/PII exposure..."
          
          # Scan for potential PHI patterns (simplified)
          if grep -r -E "ssn.*[0-9]{3}-[0-9]{2}-[0-9]{4}|medical.*record.*[0-9]+|patient.*id.*[0-9]+" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude-dir=.github \
            --exclude="*.md" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Potential PHI patterns detected - manual review required"
          else
            echo "‚úÖ No PHI patterns detected"
          fi

  ##############################################################################
  # Commit Metadata Validation
  ##############################################################################
  commit-validation:
    name: Commit Metadata Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2
          
      - name: Validate commit metadata
        run: |
          echo "üìù Validating commit metadata..."
          
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          # Check for compliance keywords (lenient for documentation)
          if echo "$COMMIT_MSG" | grep -iE "docs:|fix:|feat:|security:|refactor:"; then
            echo "‚úÖ Commit type present"
          else
            echo "‚ö†Ô∏è  Commit type recommended but not enforced"
          fi
          
          echo "‚úÖ Commit metadata validation complete"

  ##############################################################################
  # Compliance Summary
  ##############################################################################
  compliance-summary:
    name: Compliance Summary
    runs-on: ubuntu-latest
    needs: [policy-validation, phi-detection, commit-validation]
    if: always()
    
    steps:
      - name: Generate compliance report
        run: |
          echo "========================================="
          echo "COMPLIANCE VALIDATION SUMMARY"
          echo "========================================="
          echo "‚úÖ OPA Policy Validation: ${{ needs.policy-validation.result }}"
          echo "‚úÖ PHI/PII Detection: ${{ needs.phi-detection.result }}"
          echo "‚úÖ Commit Validation: ${{ needs.commit-validation.result }}"
          echo "========================================="
          
          if [ "${{ needs.policy-validation.result }}" == "failure" ] || \
             [ "${{ needs.phi-detection.result }}" == "failure" ]; then
            echo "‚ùå Compliance checks failed"
            exit 1
          fi
          
          echo "‚úÖ All compliance checks passed"
