name: GitOps 2.0 - Risk-Adaptive CI/CD Pipeline
# 
# Implements the article's vision:
# "With GitOps 2.0, pipelines adapt automatically based on the risk 
# metadata inside the commit."
#
# Risk Levels:
# - LOW: Automated deployment, basic scanning
# - MEDIUM: Enhanced scanning, canary rollout, real-time telemetry
# - HIGH: Two-person approval, threat modeling, HIPAA validation, controlled gates
# - CRITICAL: Full audit trail, compliance evidence generation, progressive exposure
#
# This pipeline reads structured commit messages and adjusts its behavior
# automatically - no manual configuration needed.

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      force_risk_level:
        description: 'Override detected risk level (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        type: choice
        options:
          - AUTO
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL

env:
  GO_VERSION: '1.23'
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io

jobs:
  ##############################################################################
  # STEP 1: Parse Commit Metadata (AI-Generated Intelligence)
  ##############################################################################
  parse-risk:
    name: ðŸ§  Parse Commit Risk Intelligence
    runs-on: ubuntu-latest
    outputs:
      risk_level: ${{ steps.parse.outputs.risk_level }}
      clinical_safety: ${{ steps.parse.outputs.clinical_safety }}
      compliance_domains: ${{ steps.parse.outputs.compliance_domains }}
      requires_dual_approval: ${{ steps.parse.outputs.requires_dual_approval }}
      phi_impact: ${{ steps.parse.outputs.phi_impact }}
      deployment_strategy: ${{ steps.parse.outputs.deployment_strategy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need parent commit for diff
      
      - name: Parse commit metadata
        id: parse
        run: |
          #!/bin/bash
          set -e
          
          # Get the last commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          echo "ðŸ“‹ Analyzing commit message..."
          echo "$COMMIT_MSG"
          
          # Extract Risk Level
          if [[ "${{ github.event.inputs.force_risk_level }}" != "" && "${{ github.event.inputs.force_risk_level }}" != "AUTO" ]]; then
            RISK_LEVEL="${{ github.event.inputs.force_risk_level }}"
            echo "âš ï¸  Risk level overridden: $RISK_LEVEL"
          elif echo "$COMMIT_MSG" | grep -q "Risk Level: CRITICAL"; then
            RISK_LEVEL="CRITICAL"
          elif echo "$COMMIT_MSG" | grep -q "Risk Level: HIGH"; then
            RISK_LEVEL="HIGH"
          elif echo "$COMMIT_MSG" | grep -q "Risk Level: MEDIUM"; then
            RISK_LEVEL="MEDIUM"
          elif echo "$COMMIT_MSG" | grep -q "Risk Level: LOW"; then
            RISK_LEVEL="LOW"
          else
            RISK_LEVEL="MEDIUM"  # Default to safe level
            echo "âš ï¸  No risk level detected, defaulting to MEDIUM"
          fi
          
          # Extract Clinical Safety
          if echo "$COMMIT_MSG" | grep -q "Clinical Safety: REQUIRES_CLINICAL_REVIEW"; then
            CLINICAL_SAFETY="REQUIRES_CLINICAL_REVIEW"
          elif echo "$COMMIT_MSG" | grep -q "Clinical Safety: CLINICAL_VALIDATION_NEEDED"; then
            CLINICAL_SAFETY="CLINICAL_VALIDATION_NEEDED"
          else
            CLINICAL_SAFETY="NO_CLINICAL_IMPACT"
          fi
          
          # Extract Compliance Domains
          if echo "$COMMIT_MSG" | grep -q "Compliance:"; then
            COMPLIANCE=$(echo "$COMMIT_MSG" | grep "Compliance:" | sed 's/Compliance: //' | tr -d '\n')
          else
            COMPLIANCE="None"
          fi
          
          # Determine if dual approval required (HIGH or CRITICAL risk)
          if [[ "$RISK_LEVEL" == "CRITICAL" || "$RISK_LEVEL" == "HIGH" ]]; then
            REQUIRES_DUAL_APPROVAL="true"
          else
            REQUIRES_DUAL_APPROVAL="false"
          fi
          
          # Check PHI impact
          if echo "$COMMIT_MSG" | grep -qi "PHI-Impact: HIGH\|phi\|patient"; then
            PHI_IMPACT="HIGH"
          else
            PHI_IMPACT="NONE"
          fi
          
          # Determine deployment strategy based on risk
          case "$RISK_LEVEL" in
            LOW)
              DEPLOYMENT_STRATEGY="direct"
              ;;
            MEDIUM)
              DEPLOYMENT_STRATEGY="canary"
              ;;
            HIGH|CRITICAL)
              DEPLOYMENT_STRATEGY="blue-green"
              ;;
            *)
              DEPLOYMENT_STRATEGY="canary"
              ;;
          esac
          
          # Output for later steps
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "clinical_safety=$CLINICAL_SAFETY" >> $GITHUB_OUTPUT
          echo "compliance_domains=$COMPLIANCE" >> $GITHUB_OUTPUT
          echo "requires_dual_approval=$REQUIRES_DUAL_APPROVAL" >> $GITHUB_OUTPUT
          echo "phi_impact=$PHI_IMPACT" >> $GITHUB_OUTPUT
          echo "deployment_strategy=$DEPLOYMENT_STRATEGY" >> $GITHUB_OUTPUT
          
          # Summary
          echo "## ðŸŽ¯ Risk Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Risk Level** | \`$RISK_LEVEL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Clinical Safety** | \`$CLINICAL_SAFETY\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Compliance** | $COMPLIANCE |" >> $GITHUB_STEP_SUMMARY
          echo "| **PHI Impact** | $PHI_IMPACT |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dual Approval** | $REQUIRES_DUAL_APPROVAL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment** | $DEPLOYMENT_STRATEGY |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Risk intelligence parsed successfully"

  ##############################################################################
  # STEP 2: Build Services (Always Required)
  ##############################################################################
  build:
    name: ðŸ—ï¸ Build Services
    runs-on: ubuntu-latest
    needs: parse-risk
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Build all services
        run: |
          echo "Building healthcare microservices..."
          mkdir -p bin
          
          for service in auth-service payment-gateway phi-service medical-device synthetic-phi-service; do
            echo "Building $service..."
            cd services/$service
            go build -v -o ../../bin/$service . || exit 1
            cd ../..
            echo "âœ… $service built successfully"
          done
      
      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: production-binaries-${{ github.sha }}
          path: bin/
          retention-days: 30

  ##############################################################################
  # STEP 3: Security Scanning (Risk-Adaptive Depth)
  ##############################################################################
  security-scan:
    name: ðŸ”’ Security Scan (${{ needs.parse-risk.outputs.risk_level }})
    runs-on: ubuntu-latest
    needs: [parse-risk, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Basic Security Scan (All Risk Levels)
        run: |
          echo "ðŸ” Running basic security scan..."
          echo "Simulated: Gitleaks secret scanning"
      
      - name: Enhanced Scan for MEDIUM+ Risk
        if: needs.parse-risk.outputs.risk_level == 'MEDIUM' || needs.parse-risk.outputs.risk_level == 'HIGH' || needs.parse-risk.outputs.risk_level == 'CRITICAL'
        run: |
          echo "ðŸ” Running enhanced security scan (MEDIUM+ risk)..."
          echo "Simulated: Trivy filesystem scan"
      
      - name: HIPAA Validation for PHI Changes
        if: contains(needs.parse-risk.outputs.compliance_domains, 'HIPAA') || needs.parse-risk.outputs.phi_impact == 'HIGH'
        run: |
          echo "ðŸ¥ Running HIPAA compliance validation..."
          echo "Checking PHI data flows..."
          
          # Check for proper encryption in PHI services
          if [ -d "services/phi-service" ]; then
            echo "âœ… PHI service detected - validating encryption..."
            grep -r "AES-256\|encryption" services/phi-service/ || echo "âš ï¸  No encryption references found"
          fi
      
      - name: Deep Scan for HIGH/CRITICAL Risk
        if: needs.parse-risk.outputs.risk_level == 'HIGH' || needs.parse-risk.outputs.risk_level == 'CRITICAL'
        run: |
          echo "ðŸ” Running deep security scan (HIGH/CRITICAL risk)..."
          echo "Simulated: SAST analysis with Semgrep"
          echo "Simulated: Dependency vulnerability scan"
      
      - name: Threat Modeling for CRITICAL Risk
        if: needs.parse-risk.outputs.risk_level == 'CRITICAL'
        run: |
          echo "ðŸŽ¯ Running threat modeling analysis (CRITICAL risk)..."
          echo "This is where automated threat modeling would run..."
          echo "- Attack surface analysis"
          echo "- Data flow mapping"
          echo "- Trust boundary validation"

  ##############################################################################
  # STEP 4: Compliance Evidence Generation (HIGH/CRITICAL Only)
  ##############################################################################
  compliance-evidence:
    name: ðŸ“‹ Generate Compliance Evidence
    runs-on: ubuntu-latest
    needs: [parse-risk, build, security-scan]
    if: needs.parse-risk.outputs.risk_level == 'HIGH' || needs.parse-risk.outputs.risk_level == 'CRITICAL'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for audit trail
      
      - name: Generate audit evidence
        run: |
          echo "ðŸ“‹ Generating compliance evidence package..."
          mkdir -p compliance-evidence
          
          # Capture commit metadata
          git log -1 --pretty=fuller > compliance-evidence/commit-details.txt
          
          # Capture file changes
          git diff HEAD~1 HEAD --stat > compliance-evidence/files-changed.txt
          
          # Generate audit report
          cat > compliance-evidence/audit-report.md <<EOF
          # Compliance Audit Report
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit**: ${{ github.sha }}
          **Risk Level**: ${{ needs.parse-risk.outputs.risk_level }}
          **Clinical Safety**: ${{ needs.parse-risk.outputs.clinical_safety }}
          **Compliance Domains**: ${{ needs.parse-risk.outputs.compliance_domains }}
          
          ## Change Summary
          $(git log -1 --pretty=%B)
          
          ## Security Validation
          - âœ… Secret scanning passed
          - âœ… Dependency scanning passed
          - âœ… SAST analysis passed
          
          ## Deployment Approval
          Status: Pending dual authorization
          Required Approvers: 2
          
          ---
          *Generated by GitOps 2.0 Risk-Adaptive Pipeline*
          EOF
          
          echo "âœ… Compliance evidence generated"
      
      - name: Upload compliance evidence
        uses: actions/upload-artifact@v6
        with:
          name: compliance-evidence-${{ github.sha }}
          path: compliance-evidence/
          retention-days: 2555  # 7 years for HIPAA

  ##############################################################################
  # STEP 5: Deploy (Risk-Adaptive Strategy - No Approval Gate for Demo)
  ##############################################################################
  deploy:
    name: ðŸš€ Deploy (${{ needs.parse-risk.outputs.deployment_strategy }})
    runs-on: ubuntu-latest
    needs: [parse-risk, build, security-scan]
    
    steps:
      - name: Deploy with LOW risk strategy (Direct)
        if: needs.parse-risk.outputs.risk_level == 'LOW'
        run: |
          echo "ðŸš€ Deploying directly (LOW risk)..."
          echo "  - No canary needed"
          echo "  - Auto-promotion enabled"
          echo "  - Basic monitoring"
      
      - name: Deploy with MEDIUM risk strategy (Canary)
        if: needs.parse-risk.outputs.risk_level == 'MEDIUM'
        run: |
          echo "ðŸ¤ Deploying with canary (MEDIUM risk)..."
          echo "  - 10% traffic for 10 minutes"
          echo "  - Monitor error rates"
          echo "  - Auto-rollback on failures"
      
      - name: Deploy with HIGH risk strategy (Blue-Green)
        if: needs.parse-risk.outputs.risk_level == 'HIGH'
        run: |
          echo "ðŸ”µðŸŸ¢ Deploying blue-green (HIGH risk)..."
          echo "  - Full parallel environment"
          echo "  - Manual traffic switch"
          echo "  - Extended monitoring period"
          echo "  - Dual approval: ${{ needs.parse-risk.outputs.requires_dual_approval }}"
      
      - name: Deploy with CRITICAL risk strategy (Progressive)
        if: needs.parse-risk.outputs.risk_level == 'CRITICAL'
        run: |
          echo "ðŸŽ¯ Deploying progressively (CRITICAL risk)..."
          echo "  - Stage 1: 5% traffic for 1 hour"
          echo "  - Stage 2: 25% traffic for 4 hours"
          echo "  - Stage 3: 50% traffic for 8 hours"
          echo "  - Stage 4: 100% traffic after validation"
          echo "  - Real-time telemetry monitoring"
          echo "  - Instant rollback capability"

  ##############################################################################
  # STEP 6: Post-Deployment Monitoring
  ##############################################################################
  monitor:
    name: ðŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [parse-risk, deploy]
    if: needs.deploy.result == 'success'
    
    steps:
      - name: Setup monitoring
        run: |
          RISK_LEVEL="${{ needs.parse-risk.outputs.risk_level }}"
          
          case "$RISK_LEVEL" in
            LOW)
              MONITOR_DURATION="5m"
              ;;
            MEDIUM)
              MONITOR_DURATION="30m"
              ;;
            HIGH)
              MONITOR_DURATION="2h"
              ;;
            CRITICAL)
              MONITOR_DURATION="24h"
              ;;
          esac
          
          echo "ðŸ“Š Monitoring for $MONITOR_DURATION..."
          echo "  - Error rate thresholds"
          echo "  - Latency monitoring"
          echo "  - PHI access patterns (if applicable)"
          
          # Generate deployment summary
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Risk Level**: $RISK_LEVEL" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: ${{ needs.parse-risk.outputs.deployment_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Monitoring Duration**: $MONITOR_DURATION" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
