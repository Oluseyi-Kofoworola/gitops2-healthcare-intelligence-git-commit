name: intelligent-pipeline-demo

on:
  push:
    branches: ["main", "feature/**"]

jobs:
  analyze-commits:
    runs-on: ubuntu-latest
    outputs:
      risk-level: ${{ steps.risk.outputs.risk-level }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Analyze commit risk
        id: risk
        run: |
          echo "Analyzing commit risk..."
          python tools/git_intel/risk_scorer.py | sed -n '1,10p'
          # For demo purposes we just set MEDIUM; in a real system you would
          # parse the output and calculate an aggregate risk.
          echo "risk-level=medium" >> "$GITHUB_OUTPUT"

  tests:
    needs: analyze-commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run unit tests (payment-gateway)
        run: |
          cd services/payment-gateway
          go test ./...

      - name: Run perf/regression smoke (medium/high risk only)
        if: needs.analyze-commits.outputs.risk-level != 'low'
        run: |
          chmod +x scripts/run_regression_check.sh
          ./scripts/run_regression_check.sh
