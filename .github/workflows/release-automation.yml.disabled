name: Release Automation

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. v1.1.0)'
        required: true

env:
  GO_VERSION: '1.22'
  PYTHON_VERSION: '3.10'

jobs:
  build-artifacts:
    name: "Build & Collect Artifacts"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      notes: ${{ steps.notes.outputs.notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive Version
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VER='${{ inputs.version }}'
          else
            VER='${{ github.ref_name }}'
          fi
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "Releasing version $VER" >> $GITHUB_STEP_SUMMARY

      - name: Extract Release Notes From CHANGELOG
        id: notes
        run: |
          VER='${{ steps.meta.outputs.version }}'
          echo "Extracting notes for $VER"
          awk -v ver="## ${VER}" '
            BEGIN{found=0}
            $0 ~ ver {found=1; next}
            /^## v/ && found==1 {exit}
            found==1 {print}
          ' CHANGELOG.md > release-notes.md || true
          if [ ! -s release-notes.md ]; then
            echo "(No specific notes found for $VER; using placeholder)" > release-notes.md
          fi
          # Escape newlines for output
          ESCAPED=$(sed ':a;N;$!ba;s/\n/\n/g' release-notes.md)
          echo "notes=$ESCAPED" >> $GITHUB_OUTPUT
          echo "### ðŸ“ Release Notes Preview" >> $GITHUB_STEP_SUMMARY
          head -n 30 release-notes.md >> $GITHUB_STEP_SUMMARY

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build Services
        run: |
          mkdir -p dist
          for svc in services/payment-gateway services/auth-service; do
            (cd $svc && go build -o ../../dist/$(basename $svc))
          done
          ls -l dist

      - name: Generate SBOM (CycloneDX)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/sbom-action/main/install.sh | sh -s -- -b /usr/local/bin
          syft dir:. -o cyclonedx-json > dist/sbom-${{ steps.meta.outputs.version }}.json
          echo "SBOM generated" >> $GITHUB_STEP_SUMMARY

      - name: "Package Compliance & Regression Artifacts If Present"
        run: |
          mkdir -p dist/extras
          [ -f compliance-report.json ] && cp compliance-report.json dist/extras/ || true
          [ -f regression-report.json ] && cp regression-report.json dist/extras/ || true
          [ -f risk-output.json ] && cp risk-output.json dist/extras/ || true
          tar -czf dist/release-extras-${{ steps.meta.outputs.version }}.tar.gz -C dist extras || true

      - name: Generate Checksums
        run: |
          echo "Generating SHA256 & SHA512 checksums" >> $GITHUB_STEP_SUMMARY
          (cd dist && sha256sum payment-gateway auth-service sbom-${{ steps.meta.outputs.version }}.json release-extras-${{ steps.meta.outputs.version }}.tar.gz 2>/dev/null > checksums.sha256 || true)
          (cd dist && sha512sum payment-gateway auth-service sbom-${{ steps.meta.outputs.version }}.json release-extras-${{ steps.meta.outputs.version }}.tar.gz 2>/dev/null > checksums.sha512 || true)
          (cd dist && ls -1 | grep -E 'payment-gateway|auth-service|sbom-|release-extras' | xargs -r -I{} sh -c 'echo {}') >> dist/artifact-list.txt || true
          echo "### ðŸ” Checksums Generated" >> $GITHUB_STEP_SUMMARY
          [ -f dist/checksums.sha256 ] && head -n 10 dist/checksums.sha256 >> $GITHUB_STEP_SUMMARY || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build-${{ steps.meta.outputs.version }}
          path: dist

  sign-and-publish:
    name: "Sign & Publish Release"
    runs-on: ubuntu-latest
    needs: build-artifacts
    permissions:
      contents: write
      id-token: write # For keyless cosign (OIDC)
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ needs.build-artifacts.outputs.version }}
          path: dist

      - name: Install Cosign
        run: |
          COSIGN_VERSION=v2.2.3
          curl -sSfL https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign >/dev/null
          sudo chmod +x /usr/local/bin/cosign

      - name: Sign Artifacts (Keyless)
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "Attempting keyless signing"
          for f in dist/payment-gateway dist/auth-service dist/sbom-*.json; do
            if [ -f "$f" ]; then
              cosign sign --yes "$f" || echo "Signing failed (demo env)"
            fi
          done
          echo "Signing step completed (failures tolerated in demo)" >> $GITHUB_STEP_SUMMARY

      - name: Generate Release Notes File
        run: |
          printf '%s\n' "${{ needs.build-artifacts.outputs.notes }}" | sed 's/\\n/\n/g' > release-notes-final.md
          echo "Final release notes prepared" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-artifacts.outputs.version }}
          name: Release ${{ needs.build-artifacts.outputs.version }}
          body_path: release-notes-final.md
          draft: false
          prerelease: false
          files: |
            dist/payment-gateway
            dist/auth-service
            dist/sbom-${{ needs.build-artifacts.outputs.version }}.json
            dist/release-extras-${{ needs.build-artifacts.outputs.version }}.tar.gz
            dist/checksums.sha256
            dist/checksums.sha512

      - name: Post Release Summary
        run: |
          echo "### ðŸš€ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ needs.build-artifacts.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts: payment-gateway, auth-service, SBOM, extras" >> $GITHUB_STEP_SUMMARY
          echo "Signing: attempted (keyless)" >> $GITHUB_STEP_SUMMARY
          echo "Checksums: SHA256 & SHA512 published" >> $GITHUB_STEP_SUMMARY
