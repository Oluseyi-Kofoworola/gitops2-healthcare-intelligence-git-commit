name: Commit Compliance Validation

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]

jobs:
  validate-commits:
    name: Validate Healthcare Compliance Metadata
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for commit validation
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate commit messages
        id: validate
        run: |
          echo "üîç Validating commit messages for compliance..."
          
          # Get list of commits to validate
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMITS=$(git log --format=%H origin/${{ github.base_ref }}..${{ github.sha }})
          else
            COMMITS=$(git log --format=%H -1)  # Just validate the latest commit
          fi
          
          # Validate each commit
          FAILED=0
          for commit in $COMMITS; do
            echo ""
            echo "Validating commit: $commit"
            git show -s --format=%B $commit > /tmp/commit-msg.txt
            
            if python scripts/validate_commit_msg.py /tmp/commit-msg.txt; then
              echo "‚úÖ Commit $commit is compliant"
            else
              echo "‚ùå Commit $commit is NOT compliant"
              FAILED=1
            fi
          done
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå One or more commits failed compliance validation"
            echo "üìñ See .github/gitops-copilot-instructions.md for schema"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All commits are compliant!"
      
      - name: Generate compliance report (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "üìä Generating compliance report..."
          python scripts/generate_compliance_report.py \
            --since="origin/${{ github.base_ref }}" \
            --until="${{ github.sha }}" \
            --output=compliance-report.md
      
      - name: Comment PR with compliance report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read the generated report
            const report = fs.readFileSync('compliance-report.md', 'utf8');
            
            // Find existing compliance comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('GitOps 2.0 Compliance Report')
            );
            
            const body = `## üè• GitOps 2.0 Compliance Report
            
            ${report}
            
            ---
            *Generated by GitOps 2.0 Healthcare Intelligence System*`;
            
            // Update existing comment or create new one
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
      
      - name: Block merge if non-compliant (main/develop only)
        if: |
          failure() && 
          github.event_name == 'pull_request' && 
          (github.base_ref == 'main' || github.base_ref == 'develop')
        run: |
          echo "::error::Cannot merge to ${{ github.base_ref }} with non-compliant commits"
          echo "::error::All commits must include HIPAA, PHI-Impact, Clinical-Safety, Regulation, and Service metadata"
          echo "::error::Use GitHub Copilot to generate compliant commit messages"
          exit 1

  check-high-risk-commits:
    name: Flag High-Risk Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check for Critical/High severity commits
        id: check-risk
        run: |
          echo "üîç Checking for high-risk commits..."
          
          HIGH_RISK_COMMITS=$(git log --format="%H" origin/${{ github.base_ref }}..${{ github.sha }} | while read commit; do
            git show -s --format=%B $commit | grep -E "(Clinical-Safety: Critical|Clinical-Safety: High|PHI-Impact: Direct)" && echo $commit
          done)
          
          if [ -n "$HIGH_RISK_COMMITS" ]; then
            echo "‚ö†Ô∏è  High-risk commits detected!"
            echo "high_risk=true" >> $GITHUB_OUTPUT
            echo "$HIGH_RISK_COMMITS" > high-risk-commits.txt
          else
            echo "‚úÖ No high-risk commits detected"
            echo "high_risk=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Require additional review for high-risk changes
        if: steps.check-risk.outputs.high_risk == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const commits = fs.readFileSync('high-risk-commits.txt', 'utf8').trim().split('\n');
            
            const body = `## ‚ö†Ô∏è  High-Risk Changes Detected
            
            This PR contains commits with **Critical** or **High** Clinical-Safety ratings, or **Direct** PHI-Impact.
            
            **Commits requiring additional review:**
            ${commits.map(c => `- \`${c}\``).join('\n')}
            
            **Required Actions:**
            - [ ] Clinical safety officer review
            - [ ] Security team approval
            - [ ] HIPAA compliance verification
            - [ ] Peer code review completed
            
            ---
            *This is an automated safety check. Do not merge without proper approvals.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['high-risk', 'requires-clinical-review']
            });

  scan-phi-exposure:
    name: Scan for Potential PHI Leaks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Scan for hardcoded PHI patterns
        run: |
          echo "üîç Scanning for potential PHI exposure..."
          
          # Patterns that might indicate PHI
          PATTERNS=(
            "patient_id"
            "ssn"
            "date_of_birth"
            "medical_record"
            "diagnosis"
            "prescription"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if git diff origin/${{ github.base_ref }}...${{ github.sha }} | grep -i "$pattern" | grep -v "^-"; then
              echo "‚ö†Ô∏è  Found potential PHI reference: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: Potential PHI-related code changes detected"
            echo "Please ensure:"
            echo "  1. PHI data is properly encrypted"
            echo "  2. Access controls are in place"
            echo "  3. Audit logging is enabled"
            echo "  4. Commit metadata reflects PHI-Impact level"
          else
            echo "‚úÖ No obvious PHI patterns detected"
          fi
