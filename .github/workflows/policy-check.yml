name: Healthcare Policy Validation
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  policy-validation:
    name: Healthcare Compliance Policy Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest
          
      - name: Validate Healthcare Policies
        run: |
          echo "ðŸ¥ Healthcare Policy Validation Starting..."
          
          # Test all OPA policies
          echo "Testing OPA policy syntax and logic..."
          opa test policies/ --verbose
          
          # Validate policy coverage
          echo "Validating policy coverage..."
          
          # Check HIPAA policies
          if ! find policies/ -name "*.rego" -exec grep -l "HIPAA\|PHI\|patient" {} \; | head -1; then
            echo "âŒ Missing HIPAA policy coverage"
            exit 1
          fi
          
          # Check FDA policies  
          if ! find policies/ -name "*.rego" -exec grep -l "FDA\|medical\|device\|clinical" {} \; | head -1; then
            echo "âŒ Missing FDA policy coverage"
            exit 1
          fi
          
          # Check SOX policies
          if ! find policies/ -name "*.rego" -exec grep -l "SOX\|financial\|audit\|control" {} \; | head -1; then
            echo "âŒ Missing SOX policy coverage"
            exit 1
          fi
          
          echo "âœ… Healthcare policy validation complete"
          
      - name: Test Policy Against Sample Commits
        run: |
          echo "ðŸ§ª Testing policies against sample commits..."
          
          # Test HIPAA compliance (must include HIPAA + PHI-Impact lines per enterprise.git policy)
          echo '{"commits": [{"sha": "test123", "message": "feat(phi): add patient encryption\nHIPAA: compliant\nPHI-Impact: HIGH\nAudit-Trail: enabled", "changed_files": ["services/phi-service/encryption.go"]}]}' | \
            opa eval -d policies/ "data.enterprise.git.allow" --input-file - | grep -q true || {
              echo "âŒ HIPAA policy test failed"
              exit 1
            }
          
          # Test FDA compliance  
          echo '{"commits": [{"sha": "test456", "message": "feat(device): update algorithm\nFDA-510k: compliant\nClinical-Safety: NO_CLINICAL_IMPACT", "changed_files": ["services/medical-device/diagnostic.go"]}]}' | \
            opa eval -d policies/ "data.enterprise.git.allow" --input-file - | grep -q true || {
              echo "âŒ FDA policy test failed"
              exit 1
            }
          
          echo "âœ… Policy validation tests passed"
          
      - name: Generate Policy Report
        run: |
          echo "ðŸ“Š Generating Healthcare Policy Report..."
          
          # Count policy rules
          TOTAL_POLICIES=$(find policies/ -name "*.rego" | wc -l)
          HIPAA_RULES=$(find policies/ -name "*.rego" -exec grep -l "HIPAA\|PHI" {} \; | wc -l)
          FDA_RULES=$(find policies/ -name "*.rego" -exec grep -l "FDA\|medical" {} \; | wc -l)  
          SOX_RULES=$(find policies/ -name "*.rego" -exec grep -l "SOX\|financial" {} \; | wc -l)
          
          cat > policy-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "commit_sha": "${{ github.sha }}",
            "policy_summary": {
              "total_policies": $TOTAL_POLICIES,
              "hipaa_policies": $HIPAA_RULES,
              "fda_policies": $FDA_RULES,
              "sox_policies": $SOX_RULES
            },
            "validation_results": {
              "syntax_valid": true,
              "logic_tests_passed": true,
              "coverage_complete": true,
              "sample_tests_passed": true
            },
            "compliance_status": "VALIDATED"
          }
          EOF
          
          echo "âœ… Policy report generated"
          cat policy-report.json
          
      - name: Upload Policy Report
        uses: actions/upload-artifact@v4
        with:
          name: healthcare-policy-report
          path: policy-report.json
          retention-days: 90
