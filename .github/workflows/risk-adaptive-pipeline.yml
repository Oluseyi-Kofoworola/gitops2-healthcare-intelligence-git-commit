name: GitOps 2.0 - Risk-Adaptive Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 3 * * *' # Daily 3AM UTC compliance/risk audit
  workflow_dispatch: {}

env:
  PYTHON_VERSION: '3.10'
  GO_VERSION: '1.22'

jobs:
  # Stage 1: Calculate Risk Score
  risk-assessment:
    name: AI-Driven Risk Assessment
    runs-on: ubuntu-latest
    outputs:
      risk_score: ${{ steps.calculate.outputs.risk_score }}
      risk_level: ${{ steps.calculate.outputs.risk_level }}
      compliance_domains: ${{ steps.calculate.outputs.compliance_domains }}
      deployment_strategy: ${{ steps.calculate.outputs.deployment_strategy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for risk analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Calculate Risk Score
        id: calculate
        run: |
          # Run AI-driven risk scorer
          python3 tools/git_intel/risk_scorer.py --max-commits 10 --json > risk-output.json
          
          # Extract risk metrics
          RISK_SCORE=$(jq -r '.summary.average_risk_score // 0.5' risk-output.json)
          RISK_LEVEL=$(jq -r '.summary.risk_distribution.high // 0' risk-output.json)
          
          # Determine deployment strategy based on risk
          if (( $(echo "$RISK_SCORE > 0.8" | bc -l) )); then
            STRATEGY="manual-approval"
          elif (( $(echo "$RISK_SCORE > 0.5" | bc -l) )); then
            STRATEGY="canary"
          else
            STRATEGY="standard"
          fi
          
          echo "risk_score=$RISK_SCORE" >> $GITHUB_OUTPUT
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "deployment_strategy=$STRATEGY" >> $GITHUB_OUTPUT
          
          # Extract compliance domains
          DOMAINS=$(jq -r '.commits[0].compliance_requirements // []' risk-output.json | jq -r 'join(",")')
          echo "compliance_domains=$DOMAINS" >> $GITHUB_OUTPUT
          
          echo "### ðŸŽ¯ Risk Assessment Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Risk Score**: $RISK_SCORE" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Strategy**: $STRATEGY" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance Domains**: $DOMAINS" >> $GITHUB_STEP_SUMMARY

  # Stage 2: Policy Enforcement (OPA)
  policy-validation:
    name: Healthcare Compliance Policy Check
    runs-on: ubuntu-latest
    needs: risk-assessment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest
      
      - name: Run OPA Policy Tests
        run: |
          echo "### ðŸ” Policy Validation" >> $GITHUB_STEP_SUMMARY
          opa test policies/ -v | tee opa-results.txt
          
          # Collect deny reasons for feedback
          opa eval -f json -d policies -I 'data.enterprise.git.deny' > deny-reasons.json || true
          if [ -s deny-reasons.json ]; then
            echo "### â— Deny Reasons" >> $GITHUB_STEP_SUMMARY
            jq -r '.result[0].expressions[0].value[]' deny-reasons.json >> $GITHUB_STEP_SUMMARY || true
          fi
          
          if [ $? -eq 0 ]; then
            echo "âœ… All policies passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Policy violations detected" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Upload Deny Reasons
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opa-deny-reasons
          path: deny-reasons.json
      
      - name: Validate Commit Compliance
        if: needs.risk-assessment.outputs.compliance_domains != ''
        run: |
          echo "Validating compliance for: ${{ needs.risk-assessment.outputs.compliance_domains }}"
          
          # Check if HIPAA compliance is required
          if [[ "${{ needs.risk-assessment.outputs.compliance_domains }}" == *"HIPAA"* ]]; then
            echo "âš•ï¸ HIPAA compliance validation required" >> $GITHUB_STEP_SUMMARY
          fi

  # Stage 3: Build & Test (Risk-Adaptive)
  build-and-test:
    name: Build & Test (Risk Level ${{ needs.risk-assessment.outputs.risk_level }})
    runs-on: ubuntu-latest
    needs: [risk-assessment, policy-validation]
    
    strategy:
      matrix:
        service: [payment-gateway, auth-service]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: | 
            ~/.cache/go-build
            ~/go/pkg/mod
          key: go-${{ runner.os }}-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-${{ runner.os }}-${{ env.GO_VERSION }}-
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run Unit Tests
        working-directory: services/${{ matrix.service }}
        run: |
          go test ./... -v -cover -coverprofile=coverage.out
          go tool cover -func=coverage.out | tee coverage-func.txt
          TOTAL=$(grep 'total:' coverage-func.txt | awk '{print $3}' | sed 's/%//')
          MIN=60
          if (( $(echo "$TOTAL < $MIN" | bc -l) )); then
            echo "Coverage $TOTAL% below threshold $MIN%" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… Coverage $TOTAL% meets threshold $MIN%" >> $GITHUB_STEP_SUMMARY
      
      - name: Run Integration Tests
        if: fromJSON(needs.risk-assessment.outputs.risk_score) > 0.5
        working-directory: services/${{ matrix.service }}
        run: |
          echo "ðŸ§ª Running integration tests for medium/high-risk changes"
          go test -tags=integration ./... -v
      
      - name: Build Service
        working-directory: services/${{ matrix.service }}
        run: |
          go build -o ${{ matrix.service }} .
      
      - name: Run Regression Script (payment-gateway medium/high risk only)
        if: matrix.service == 'payment-gateway' && fromJSON(needs.risk-assessment.outputs.risk_score) > 0.5
        run: |
          chmod +x scripts/run_regression_check.sh
          ./scripts/run_regression_check.sh
      
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: services/${{ matrix.service }}/coverage.out
      
      - name: Upload Coverage Function Summary
        uses: actions/upload-artifact@v4
        with:
          name: coverage-func-${{ matrix.service }}
          path: services/${{ matrix.service }}/coverage-func.txt

      - name: Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: services/${{ matrix.service }}/coverage.out
          flags: ${{ matrix.service }}
          fail_ci_if_error: false

  # Stage 4: Regression Detection (Always executes; internal logic handles risk threshold)
  regression-detection:
    name: AI-Driven Regression Detection
    runs-on: ubuntu-latest
    needs: [risk-assessment, build-and-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Evaluate Regression Trigger
        id: eval
        run: |
          RISK=${{ needs.risk-assessment.outputs.risk_score }}
          echo "risk=$RISK" >> $GITHUB_OUTPUT
          if (( $(echo "$RISK > 0.6" | bc -l) )); then
            echo "trigger=true" >> $GITHUB_OUTPUT
          else
            echo "trigger=false" >> $GITHUB_OUTPUT
          fi
          echo "### ðŸ§ª Regression Detection Trigger" >> $GITHUB_STEP_SUMMARY
          echo "- Risk Score: $RISK" >> $GITHUB_STEP_SUMMARY
          echo "- Will Run Bisect: $([[ $(echo "$RISK > 0.6" | bc -l) -eq 1 ]] && echo 'Yes' || echo 'No (below threshold)')" >> $GITHUB_STEP_SUMMARY
      
      - name: Run Intelligent Bisect
        if: steps.eval.outputs.trigger == 'true'
        run: |
          echo "ðŸ” Running AI-driven regression detection"
          python3 tools/intelligent_bisect.py \
            --baseline HEAD~5 \
            --target HEAD \
            --threshold-ms 200 \
            --json --output regression-report.json
          
          if [ -f regression-report.json ]; then
            REGRESSION_FOUND=$(jq -r '.regression_detected // false' regression-report.json)
            echo "### ðŸ“Š Regression Report Generated" >> $GITHUB_STEP_SUMMARY
            if [ "$REGRESSION_FOUND" = "true" ]; then
              echo "âš ï¸ Performance regressions detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No regressions detected" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: Upload Regression Report
        if: steps.eval.outputs.trigger == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: regression-report
          path: regression-report.json
      
      - name: Skip Notice
        if: steps.eval.outputs.trigger != 'true'
        run: |
          echo "Regression detection skipped (risk below threshold)." >> $GITHUB_STEP_SUMMARY

  # Stage 5: Healthcare Compliance Scan (Always executes; internal conditional)
  compliance-scan:
    name: Healthcare Compliance Framework
    runs-on: ubuntu-latest
    needs: risk-assessment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Assess Compliance Domains
        id: domains
        run: |
          DOMAINS='${{ needs.risk-assessment.outputs.compliance_domains }}'
          echo "domains=$DOMAINS" >> $GITHUB_OUTPUT
          echo "### ðŸ¥ Compliance Domain Assessment" >> $GITHUB_STEP_SUMMARY
          echo "- Domains: ${DOMAINS:-NONE}" >> $GITHUB_STEP_SUMMARY
      
      - name: Run AI Compliance Framework
        if: steps.domains.outputs.domains != ''
        run: |
          python3 tools/ai_compliance_framework.py analyze-commit HEAD --json > compliance-report.json
          # Basic SBOM generation placeholder (future: syft/trivy integration)
          echo '{"sbom":"placeholder"}' > sbom.json
          COMPLIANCE_STATUS=$(jq -r '.commit_analysis.compliance_status' compliance-report.json)
          RISK_SCORE=$(jq -r '.commit_analysis.risk_score' compliance-report.json)
          echo "### ðŸ¥ Healthcare Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: $COMPLIANCE_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Risk Score**: $RISK_SCORE" >> $GITHUB_STEP_SUMMARY
          if [ "$COMPLIANCE_STATUS" = "NON_COMPLIANT" ]; then
            echo "âŒ Compliance violations detected - deployment blocked" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: No Domains Skip Notice
        if: steps.domains.outputs.domains == ''
        run: |
          echo "No compliance domains detected; framework run skipped." >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Compliance Report
        if: steps.domains.outputs.domains != ''
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.json
      
      - name: Upload SBOM
        if: steps.domains.outputs.domains != ''
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  # Stage 6: Deployment Strategy Selection (Always runs; removed branch restriction)
  deploy-strategy:
    name: Select Deployment Strategy
    runs-on: ubuntu-latest
    needs: [risk-assessment, build-and-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Display Deployment Plan
        run: |
          echo "### ðŸš€ Deployment Strategy" >> $GITHUB_STEP_SUMMARY
          echo "**Selected Strategy**: ${{ needs.risk-assessment.outputs.deployment_strategy }}" >> $GITHUB_STEP_SUMMARY
          case "${{ needs.risk-assessment.outputs.deployment_strategy }}" in
            "manual-approval")
              echo "âš ï¸ **HIGH RISK** - Manual approval required before deployment" >> $GITHUB_STEP_SUMMARY
              echo "- Risk Score: ${{ needs.risk-assessment.outputs.risk_score }}" >> $GITHUB_STEP_SUMMARY
              echo "- Requires: Security team approval + Compliance officer sign-off" >> $GITHUB_STEP_SUMMARY
              ;;
            "canary")
              echo "ðŸ“Š **MEDIUM RISK** - Canary deployment strategy" >> $GITHUB_STEP_SUMMARY
              echo "- Stage 1: 5% traffic for 15 minutes" >> $GITHUB_STEP_SUMMARY
              echo "- Stage 2: 25% traffic for 30 minutes" >> $GITHUB_STEP_SUMMARY
              echo "- Stage 3: 100% traffic if metrics healthy" >> $GITHUB_STEP_SUMMARY
              echo "- Auto-rollback if error rate > 1%" >> $GITHUB_STEP_SUMMARY
              ;;
            "standard")
              echo "âœ… **LOW RISK** - Standard deployment" >> $GITHUB_STEP_SUMMARY
              echo "- Direct deployment to production" >> $GITHUB_STEP_SUMMARY
              echo "- Automated health checks enabled" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
      - name: Run Canary Rollout Simulation
        if: needs.risk-assessment.outputs.deployment_strategy == 'canary'
        run: |
          chmod +x scripts/canary_rollout_sim.sh
          ./scripts/canary_rollout_sim.sh
      - name: Manual Approval Gate
        if: needs.risk-assessment.outputs.deployment_strategy == 'manual-approval'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: compliance-team,security-team
          minimum-approvals: 2
          issue-title: "High-Risk Deployment Approval Required"
          issue-body: |
            ### ðŸš¨ High-Risk Change Detected
            
            **Risk Score**: ${{ needs.risk-assessment.outputs.risk_score }}
            **Compliance Domains**: ${{ needs.risk-assessment.outputs.compliance_domains }}
            
            Please review and approve this deployment.

  # Stage 7: Summary Report
  workflow-summary:
    name: GitOps 2.0 Workflow Summary
    runs-on: ubuntu-latest
    needs: [risk-assessment, policy-validation, build-and-test, regression-detection, compliance-scan, deploy-strategy]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ GitOps 2.0 Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Risk-Adaptive Intelligence" >> $GITHUB_STEP_SUMMARY
          echo "- **Risk Score**: ${{ needs.risk-assessment.outputs.risk_score }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Strategy**: ${{ needs.risk-assessment.outputs.deployment_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance Domains**: ${{ needs.risk-assessment.outputs.compliance_domains }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Risk Assessment: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.policy-validation.result == 'success' && 'âœ…' || 'âŒ' }} Policy Validation: ${{ needs.policy-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.build-and-test.result == 'success' && 'âœ…' || 'âŒ' }} Build & Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.regression-detection.result == 'success' && 'âœ…' || 'âŒ' }} Regression Detection Job: ${{ needs.regression-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.compliance-scan.result == 'success' && 'âœ…' || 'âŒ' }} Healthcare Compliance: ${{ needs.compliance-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.deploy-strategy.result == 'success' && 'âœ…' || 'âŒ' }} Deployment Strategy: ${{ needs.deploy-strategy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## GitOps 2.0 Principles Demonstrated" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Intent-Driven Commits - Analyzed via semantic parsing" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… AI-Native Intelligence - Risk scoring with ML" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Machine-Readable Records - JSON output at every stage" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Policy-Driven Governance - OPA enforcement" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… Risk-Adaptive Workflows - Dynamic deployment selection" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… Semantic Foundation - Conventional Commits parsed" >> $GITHUB_STEP_SUMMARY
          echo "7. âœ… Git Intelligence Engine - Forensics & regression detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage reports per service" >> $GITHUB_STEP_SUMMARY
          echo "- Regression report (if triggered)" >> $GITHUB_STEP_SUMMARY
          echo "- Compliance report + SBOM (if domains present)" >> $GITHUB_STEP_SUMMARY
          echo "- OPA deny reasons (if any)" >> $GITHUB_STEP_SUMMARY
