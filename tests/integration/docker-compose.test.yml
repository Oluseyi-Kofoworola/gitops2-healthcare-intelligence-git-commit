# Docker Compose - Integration Test Environment
# Runs all 3 microservices locally for integration testing

version: '3.8'

services:
  # OpenTelemetry Collector for distributed tracing
  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./tests/integration/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "13133:13133" # Health check
    networks:
      - test-network

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./tests/integration/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - test-network

  # Auth Service
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    environment:
      - PORT=8080
      - JWT_SECRET=test-secret-key-for-integration-testing-only
      - JWT_EXPIRATION=15m
      - OTLP_ENDPOINT=otel-collector:4317
      - LOG_LEVEL=debug
      - ENV=integration
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      - otel-collector
      - prometheus
    networks:
      - test-network

  # Payment Gateway
  payment-gateway:
    build:
      context: ./services/payment-gateway
      dockerfile: Dockerfile
    environment:
      - PORT=8081
      - AUTH_SERVICE_URL=http://auth-service:8080
      - PHI_SERVICE_URL=http://phi-service:8083
      - OTLP_ENDPOINT=otel-collector:4317
      - LOG_LEVEL=debug
      - ENV=integration
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      - auth-service
      - otel-collector
    networks:
      - test-network
  # PHI Service
  phi-service:
    build:
      context: ./services/phi-service
      dockerfile: Dockerfile
    environment:
      - PORT=8083
      - MASTER_KEY=test-master-key-32-bytes-long-change-in-production
      - OTLP_ENDPOINT=otel-collector:4317
      - LOG_LEVEL=debug
      - ENV=integration
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8083/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      - otel-collector
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
