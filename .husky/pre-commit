#!/bin/bash
# Pre-commit hook to prevent committing secrets
# GitOps 2.0 Healthcare Intelligence

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ğŸ”’ Running secret detection..."

# Check for common secret patterns
SECRET_PATTERNS=(
    "sk-proj-[A-Za-z0-9_-]{20,}"  # OpenAI API keys
    "ghp_[A-Za-z0-9]{36}"          # GitHub Personal Access Tokens
    "AKIA[0-9A-Z]{16}"             # AWS Access Keys
    "AIza[0-9A-Za-z-_]{35}"        # Google API Keys
    "xox[pboa]-[0-9]{12}-[0-9]{12}-[0-9]{12}-[a-z0-9]{32}"  # Slack tokens
)

# Get list of files to be committed
FILES=$(git diff --cached --name-only --diff-filter=ACM)

FOUND_SECRETS=0

for FILE in $FILES; do
    if [ -f "$FILE" ]; then
        # Check each secret pattern
        for PATTERN in "${SECRET_PATTERNS[@]}"; do
            if grep -qE "$PATTERN" "$FILE"; then
                echo -e "${RED}âŒ BLOCKED: Potential secret detected in $FILE${NC}"
                echo -e "${YELLOW}   Pattern: $PATTERN${NC}"
                echo ""
                FOUND_SECRETS=1
            fi
        done
        
        # Check for common secret file names
        if [[ "$FILE" =~ \.env$ ]] && [[ ! "$FILE" =~ \.env\.example$ ]]; then
            echo -e "${RED}âŒ BLOCKED: Attempting to commit .env file${NC}"
            echo -e "${YELLOW}   File: $FILE${NC}"
            echo ""
            FOUND_SECRETS=1
        fi
        
        # Check for private key files
        if [[ "$FILE" =~ \.(key|pem|p12|pfx)$ ]]; then
            echo -e "${RED}âŒ BLOCKED: Attempting to commit private key file${NC}"
            echo -e "${YELLOW}   File: $FILE${NC}"
            echo ""
            FOUND_SECRETS=1
        fi
    fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘   âš ï¸  COMMIT BLOCKED: SECRETS DETECTED               â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "What to do:"
    echo "  1. Remove the secrets from the files"
    echo "  2. Use environment variables instead"
    echo "  3. Add sensitive files to .gitignore"
    echo "  4. Review: docs/API_KEY_SECURITY.md"
    echo ""
    exit 1
fi

echo "âœ… No secrets detected. Commit allowed."
exit 0
